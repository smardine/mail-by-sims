<?xml version="1.0" encoding="UTF-8"?>

<project basedir="." default="sonar" name="Mail by sims">

  <!-- project-specific variables -->
  <property name="package.name" value="wikitex.jar" />
  <property name="properties.file" value="wikitex.properties" />
  <property name="manifest.main.class" value="com.devdaily.wikitex.Main" />
  <property name="manifest.built.by" value="Alvin J. Alexander" />
  <property name="manifest.created.by" value="DevDaily.com" />
  <property name="version.number" value="1.0" />
  <property name="build.number" value="1984" />
  <property name="lib.dir" value="lib" />
  <property name="lib.cobertura.dir" value="${lib.dir}/cobertura" />
  <property name="cobertura.jar.file" value="${lib.cobertura.dir}/cobertura.jar" />
  <property name="src.tests.dir" value="test" />
  <property name="cob.ser.file" value="cobertura.ser" />

  <property environment="env" />
  <property name="build.dir" value="build" />
  <property file="${build.dir}/build.${env.HOSTNAME}" />

  <property name="src.dir" value="src" />
  <property name="reports.dir" value="reports" />
  <property name="resources.dir" value="resources" />
  <property name="dest.dir" value="target" />
  <property name="dest.dir.classes" value="${dest.dir}/classes" />
  <property name="dest.dir.lib" value="${dest.dir.classes}/lib" />
  <property name="package.file" value="${dest.dir}/${package.name}" />

  <!-- cobertura properties -->
  <property name="cobertura.dir" value="cobertura" />
  <property name="cob.instrumented.dir" value="${cobertura.dir}/instrumented" />
  <property name="cob.reports.dir" value="${cobertura.dir}/reports" />
  <property name="cob.reports.xml.dir" value="${cob.reports.dir}/junit-xml" />
  <property name="cob.reports.html.dir" value="${cob.reports.dir}/junit-html" />
  <property name="cob.coverage.xml.dir" value="${cob.reports.dir}/cobertura-xml" />
  <property name="cob.coverage.html.dir" value="${cob.reports.dir}/cobertura-html" />

  <path id="build.class.path">
    <fileset dir="lib">
      <include name="**/*.jar" />
    </fileset>
  </path>
  
  <target name="clean">
    <delete dir="${dest.dir}" />
    <delete dir="${reports.dir}" />
    <delete dir="${cobertura.dir}" />
    <delete file="${cob.ser.file}" />
  </target>

  <target name="prepare" depends="clean">
    <mkdir dir="${dest.dir}" />
    <mkdir dir="${dest.dir.classes}" />
    <mkdir dir="${dest.dir.classes}/META-INF" />
    <mkdir dir="${reports.dir}" />
    <!-- cobertura directories -->
    <mkdir dir="${cobertura.dir}" />
    <mkdir dir="${cob.instrumented.dir}" />
    <mkdir dir="${cob.reports.xml.dir}" />
    <mkdir dir="${cob.reports.html.dir}" />
    <mkdir dir="${cob.coverage.xml.dir}" />
    <mkdir dir="${cob.coverage.html.dir}" />
  </target>
  
   <target name="compile" depends="prepare">
    <echo>=== COMPILE ===</echo>
        <echo>Compiling ${src.dir} files ...</echo>
    <javac debug="on" srcdir="${src.dir}" destdir="${dest.dir.classes}" includes="com/**">
      <classpath refid="build.class.path" />
      <!-- classpath refid="cobertura.classpath" -->
    </javac>

    <!-- compile files on the src-tests path -->
        <echo>Compiling ${src.tests.dir} files ...</echo>
    <javac debug="on" srcdir="${src.tests.dir}" destdir="${dest.dir.classes}" includes="com/**">
      <classpath refid="build.class.path" />
      <!-- classpath refid="cobertura.classpath" -->
    </javac>
  </target>

      
 

  <!-- classpath for test needs to include the dist/classes directory -->
  <path id="classpath.test">
    <pathelement location="${dest.dir.classes}" />
    <fileset dir="lib">
      <include name="**/*.jar" />
    </fileset>
  </path>

  <!-- may want to modify this, and only allow deployment if the tests run -->
  <target name="test" description="Run JUnit Tests" depends="compile">
    <echo>=== UNIT TESTS ===</echo>
    <delete>
      <fileset dir="${reports.dir}" includes="**/TEST-*.txt"/>
    </delete>
    <junit dir="./" printsummary="yes" fork="yes" haltonfailure="yes">
      <formatter type="plain"/>
      <batchtest fork="yes" todir="${reports.dir}">
          <fileset dir="${dest.dir.classes}">
            <include name="**/Test*"/>
            <include name="**/*Tests*"/>
            <exclude name="**/AllTests*"/>
          <exclude name="**/TestingUtils*"/>
          </fileset>
          </batchtest>
      <classpath>
              <path refid="classpath.test"/>
        </classpath>
    </junit>
  </target>
  
   <!-- cobertura task definition -->
  <path id="cobertura.classpath">
    <fileset dir="${lib.dir}">
      <include name="${cobertura.jar.file}" />
      <include name="**/*.jar" />
    </fileset>
  </path>
    <taskdef classpathref="cobertura.classpath" resource="tasks.properties"/>
  
  <target name="instrument" depends="compile">
    <cobertura-instrument todir="${cob.instrumented.dir}">
      <fileset dir="${dest.dir.classes}">
        <include name="**/*.class"/>
      </fileset>
    </cobertura-instrument>
  </target>

  <target name="cover-test" depends="instrument">
    <junit dir="./" failureproperty="test.failure" printsummary="yes" 
      fork="true" haltonerror="true">
        <classpath location="${cobertura.jar.file}"/>
        <classpath location="${cob.instrumented.dir}"/>
      <classpath>
              <path refid="build.class.path"/>
        </classpath>
      <batchtest fork="yes" todir="${reports.dir}">
          <fileset dir="${cob.instrumented.dir}">
            <include name="**/Test*"/>
            <include name="**/*Tests*"/>
            <include name="org/jaxen/javabean/*Test*" />
          <exclude name="**/TestingUtils*"/>
            <exclude name="**/AllTests*"/>
          </fileset>
          </batchtest>
    </junit>
  </target>
  
  <!-- run this target to generate the coverage reports -->
  <target name="coverage-report" depends="cover-test">
    <cobertura-report srcdir="${src.dir}" destdir="${cobertura.dir}"/>
  </target>
  
  

</project>
