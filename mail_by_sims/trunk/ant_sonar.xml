<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<project basedir="." default="sonar" name="Mail by sims">
	 <property name="junit.output.dir" value="junit"/>
	<property name="instrumented.dir" value="cobertura/instrumented"/>
	<property name="classes.dir" value="bin"/>
	<property name="jars.dir" value="lib"/>
	<property name="test.dir" value="test"/>
	<property name="cobertura.dir" value="${jars.dir}/cobertura"/>
	<property name="reports.xml.dir" value="cobertura/reports"/>
	<property name="cob.ser.file" value="cobertura.ser" />
	
	 <!-- Define the Sonar task if this hasn't been done in a common script -->
  <taskdef uri="antlib:org.sonar.ant" resource="org/sonar/ant/antlib.xml">
    <classpath path="C:\hudson\tools\my_ant\lib" />
 </taskdef>
	
	<path id="cobertura.classpath">
	    <fileset dir="${cobertura.dir}">
	        <include name="cobertura.jar" />
	        <include name="lib/**/*.jar" />
	    </fileset>
		<fileset dir="${jars.dir}">
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<taskdef classpathref="cobertura.classpath" resource="tasks.properties" />
	<target name="clean" >
		<delete dir="${instrumented.dir}" />
		<delete dir="${reports.xml.dir}" />
		<delete file="${cob.ser.file}" />
	</target>
	
	<target name="prepare" depends="clean">
		    <mkdir dir="${instrumented.dir}" />
		    <mkdir dir="${reports.xml.dir}" />
	</target>
	<target name="instrument" depends="prepare">
		<cobertura-instrument todir="${instrumented.dir}">
			    <ignore regex="org.apache.log4j.*" />
			    <fileset dir="${classes.dir}">
			        <include name="**/*.class" />
			        <exclude name="**/*Test.class" />
			    </fileset>
			    
			</cobertura-instrument>
	</target>
	
	
	
	<target name="testsuite" depends="instrument">
		<junit fork="yes" dir="${test.dir}" failureProperty="test.failed"  printsummary="withOutAndErr">
				<!--
					Specify the name of the coverage data file to use.
					The value specified below is the default.
				-->
				<sysproperty key="net.sourceforge.cobertura.datafile"
					file="${basedir}/cobertura.ser" />
				<!--
					Note the classpath order: instrumented classes are before the
					original (uninstrumented) classes.  This is important.
				-->
				<classpath location="${instrumented.dir}" />
				<classpath location="${classes.dir}" />
			
				<!--
					The instrumented classes reference classes used by the
					Cobertura runtime, so Cobertura and its dependencies
					must be on your classpath.
				-->
				<classpath refid="cobertura.classpath" />

				<formatter type="xml" />
				<test name="test.TestSuiteClientMail" todir="${reports.xml.dir}" />
				
				<!--<batchtest todir="${reports.xml.dir}" unless="testcase">
					<fileset dir="${test.dir}">
						<include name="**/*Test*.java" />
					</fileset>
				</batchtest>-->
			</junit>
	</target>
	
	<target name="cover-report" depends="testsuite">
		<cobertura-report format="xml" destdir="${reports.xml.dir}" srcdir="${test.dir}" />
	</target>
	
  
  <!-- Add the target -->
  <target name="sonar" depends="cover-report">
    <!-- The workDir directory is used by Sonar to store temporary files -->
    <sonar:sonar workDir="./" key="fr.simscorps:client.mail" version="0.1-SNAPSHOT" xmlns:sonar="antlib:org.sonar.ant">
	<property key="sonar.host.url" value="http://172.30.3.55:1234/sonar/" />
      <!-- source directories (required) -->
      <sources>
        <path location="./src" />
      </sources>
 
      <!-- list of properties (optional) -->
      <property key="sonar.dynamicAnalysis" value="true" />
      <property key="sonar.projectName" value="client mail" />
      <property key="sonar.java.source" value="1.5" />
      <property key="sonar.projectVersion" value="0.1-SNAPSHOT" /> 
      <property key="sonar.phase" value="generate-sources"/>
      <property key="sonar.cobertura.reportsPath" value="${reports.xml.dir}/coverage.xml"/>
      <property key="sonar.surefire.reportsPath" value="${reports.xml.dir}/TESTS-test.TestSuiteClientMail.xml" />
     
    	
 
      <!-- test source directories (optional) -->
      <tests>
        <path location="./test" />
      </tests>
 
      <!-- binaries directories, which contain for example the compiled Java bytecode (optional) -->
      <binaries>
        <path location="./bin" />
      </binaries>
 
      <!-- path to libraries (optional). These libraries are for example used by the Java Findbugs plugin -->
      <libraries>
      	<path location="./lib/activation.jar" />
      	<path location="./lib/deltasync.jar" />
       	<path location="./lib/jaybird_full_2_1_6.jar" />
       	<path location="./lib/junit.jar" />
       	<path location="./lib/mail.jar" />
       	<path location="./lib/libdeltasync/apache-mime4j-0.5.jar"/>
      	<path location="./lib/libdeltasync/commons-codec-1.5.jar"/>
        <path location="./lib/libdeltasync/commons-codec-1.5-javadoc.jar"/>
        <path location="./lib/libdeltasync/commons-codec-1.5-sources.jar"/>
        <path location="./lib/libdeltasync/commons-logging-1.1.1.jar"/>
        <path location="./lib/libdeltasync/httpclient-4.1.1.jar"/>
        <path location="./lib/libdeltasync/httpclient-cache-4.1.1.jar"/>
        <path location="./lib/libdeltasync/httpcore-4.1.jar"/>
        <path location="./lib/libdeltasync/httpmime-4.1.1.jar"/>
        <path location="./lib/libdeltasync/logback-classic-0.9.29.jar"/>
        <path location="./lib/libdeltasync/logback-classic-0.9.29-sources.jar"/>
        <path location="./lib/libdeltasync/logback-core-0.9.29.jar"/>
        <path location="./lib/libdeltasync/logback-core-0.9.29-sources.jar"/>
        <path location="./lib/libdeltasync/slf4j-api-1.6.1.jar"/>
        <path location="./lib/libdeltasync/slf4j-api-1.6.1-sources.jar"/>
      </libraries>
    </sonar:sonar>
  </target>


</project>